@model IEnumerable<TravelAgencyWebApp.Data.Models.Offer>
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@inject RoleManager<IdentityRole<Guid>> roleManager
@{
	ViewData["Title"] = "Admin Dashboard";
}
@{
	IEnumerable<string?> allRoles = await roleManager.Roles
		.Select(r => r.Name)
		.ToArrayAsync();
}
<div class="container mt-5">
	<h2 class="text-center">Администраторски панел</h2>

	<h3>Управление на Оферти</h3>
	<table class="table table-striped">
		<thead>
			<tr>
				<th>Заглавие</th>
				<th>Описание</th>
				<th>Цена</th>
				<th>Действия</th>
			</tr>
		</thead>
		<tbody>
			@foreach (var offer in Model)
			{
				<tr>
					<td>@offer.Title</td>
					<td>@offer.Description</td>
					<td>@offer.Price.ToString("C")</td>
					<td>
						<!-- Notice the asp-area="" to redirect to the Offer/Create view correctly -->
						<a asp-controller="Offer" asp-action="Create" asp-area="" class="btn btn-primary">Добави Нова Оферта</a>
						<!-- Redirect to Offer Edit page -->
						<a asp-controller="Offer" asp-action="Edit" asp-route-id="@offer.Id" asp-area="" class="btn btn-warning">Редактиране</a>

						<!-- Form to delete the offer -->
						<form asp-controller="Offer" asp-action="Delete" asp-route-id="@offer.Id" asp-area="" method="post" style="display:inline;">
							<input type="submit" class="btn btn-danger" value="Изтриване" onclick="return confirm('Сигурни ли сте, че искате да изтриете тази оферта?');" />
						</form>
					</td>
				</tr>
			}
		</tbody>
	</table>

	<h3>Управление на Потребители</h3>
	<table class="table table-striped">
		<thead>
			<tr>
				<th>Email</th>
				<th>Full Name</th>
				<th>Действия</th>
			</tr>
		</thead>
		<tbody>
			@foreach (var user in ViewBag.Users) // Use ViewBag to list users
			{
				<tr>
					<td>@user.Email</td>
					<td>@user.FullName</td>
					<td>
						<form method="post" asp-action="AssignRole" asp-controller="Home" asp-area="Admin" class="d-inline">
							<input type="hidden" name="userId" value="@user.Id" />
							<select name="role" class="form-select d-inline w-auto">
								@foreach (string role in allRoles)
								{
									<option value="@role">@role</option>
								}
							</select>
							<button type="submit" class="btn btn-primary btn-sm">Присвояване на роля</button>
						</form>

						<form method="post" asp-action="RemoveRole" asp-controller="Home" asp-area="Admin" class="d-inline ms-2">
							<input type="hidden" name="userId" value="@user.Id" />
							<select name="role" class="form-select d-inline w-auto">
								@foreach (var role in user.Roles)
								{
									<option value="@role">@role</option>
								}
							</select>
							<button type="submit" class="btn btn-warning btn-sm">Изтриване на роля</button>
						</form>

						<form method="post" asp-action="DeleteUser" asp-controller="Home" asp-area="Admin" class="d-inline ms-2">
							<input type="hidden" name="userId" value="@user.Id" />
							<button type="submit" class="btn btn-danger btn-sm">Изтрий потребителя</button>
						</form>
					</td>
				</tr>
			}
		</tbody>
	</table>

	<!-- Manage Reviews Section -->
	<h3>Отзиви от Клиенти</h3>
	<table class="table table-striped">
		<thead>
			<tr>
				<th>Потребител</th>
				<th>Съдържание</th>
				<th>Оценка</th>
				<th>Действия</th>
			</tr>
		</thead>
		<tbody>
			@foreach (var review in ViewBag.Reviews)
			{
				<tr>
					<td>@review.UserName</td>
					<td>@review.Content</td>
					<td>@review.Rating</td>
					<td>
						<a asp-area="Admin" asp-controller="Review" asp-action="Edit" asp-route-id="@review.Id" class="btn btn-warning">Редактиране</a>

						<form asp-area="Admin" asp-controller="Review" asp-action="Delete" asp-route-id="@review.Id" method="post" style="display:inline;">
							<input type="submit" class="btn btn-danger" value="Изтриване" onclick="return confirm('Сигурни ли сте, че искате да изтриете този отзив?');" />
						</form>
					</td>
				</tr>
			}
		</tbody>
	</table>
</div>
@section Scripts {
	<script src="~/Content/scripts/jquery.min.js" asp-append-version="true"></script>
	<script src="~/Content/styles/bootstrap4/bootstrap.bundle.min.js" asp-append-version="true"></script>
}